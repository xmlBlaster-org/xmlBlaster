<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<!--
   Invoke to open a Window which holds the persistent http connection:
   http://localhost/persistentWindow/index.html?ActionType=login&xmlBlaster.loginName=martin&xmlBlaster.passwd=secret&callUrl=myApp.html
-->

<html>
   <head>
      <title>XmlBlaster Persistent Callback</title>
      <meta http-equiv="Content-Type" CONTENT="text/html; charset=ISO-8859-1">
      <meta http-equiv='Pragma' content='no-cache'>
      <meta http-equiv='Expires' content='Tue, 31 Dec 1997 23:59:59 GMT'>

      <!-- xparse is a Javascript XML-DOM parser from http://www.jeremie.com/Dev/XML/index.jer Copyright 1998 Jeremie -->
      <script Language="JavaScript" src="../javascript/util.js" type="text/javascript"></script>
      <script Language="JavaScript" src="../javascript/xparse.js" type="text/javascript"></script>
      <script Language="JavaScript" src="../javascript/callback.js" type="text/javascript"></script>

      <script language="JavaScript1.2">
         // Set initial debugging level here:
         Log.INFO = false;
         Log.TRACE = false;

         //alert("href=" + location.href + " search=" + location.search + " hash=" + location.hash);

         /**
          * The Servlet is pinging the browser to keep connection alive.
          * This method is invoked from the callbackFrame.
          * @param state The string "refresh-73"<br />
          *        When login is done successfully, state="loginSucceeded" is sent one time
          */
         function ping(state) {
            if (state == "loginSucceeded") {
               Log.info("Received ping for successful login");
               self.opener.loginSucceeded(self); // callback my opener that the connection is established
            }
            else {
               // Response to servlet that we are alive ...
               if (Log.TRACE) Log.trace("Received ping '" + state + "', sending pong back to servlet");
               // Force a reload, is necessary for MSIE5, otherwise its refreshed from the browser cache
               self.frames["pingFrame"].location.reload(true);
               // Sending the state is for debugging and for proxies to let it through (not a similar request)
               self.frames["pingFrame"].location.href="/xmlBlaster/BlasterHttpProxyServlet?ActionType=pong&state=" + state;
            }
            if ((typeof pingTimeoutHandler) != "undefined")
               window.clearTimeout(pingTimeoutHandler);

            // Check for ping every 15 seconds, this value needs to
            // be bigger than the HttpPushHandler.java  PING_INTERVAL value
            pingTimeoutHandler = window.setTimeout( "cutConnection()", 35000);
         }

         /**
          * Timeout occurred, lost the server
          */
         function cutConnection() {
            Log.info("Entering cutConnection() ...");
            self.connectionTextFrame.document.location.href="notConnected.html";
         }

         /**
          * This allows to notify the servlet that the browser processed the
          * last request and is ready to receive the next message.
          */
         function browserReady()
         {
            if (Log.TRACE) Log.trace("Sending browserReady() to serlvet");
            // add some dynamic data (milliseconds since 1970), that MSIE 5 resends it.
            var date = new Date();
            var millisec = Date.parse(date);
            self.frames["controlFrame"].location.reload(true);
            self.frames["controlFrame"].location.href="/xmlBlaster/BlasterHttpProxyServlet?ActionType=browserReady&counter=" + millisec;
         }

         /**
          * This allows to notify the servlet that the browser processed the
          * last request and is ready to receive the next message.
          */
         function request(methodName, msgWrapper)
         {
            if (Log.TRACE) Log.trace("Sending request " + methodName + " to serlvet");
            self.frames["requestFrame"].location.reload(true);
            self.frames["requestFrame"].location.href="/xmlBlaster/BlasterHttpProxyServlet?ActionType="+methodName+"&key.oid=" + msgWrapper.key.oid;
         }

         queueing = true;
      </script>
   </head>

<!-- frames -->
<frameset cols="1,1,1,1,*" frameborder="0" border=0 framespacing="0" borderwidth="1">
<frame name="callbackFrame" src="loginCB.html" scrolling="no" marginwidth="0" leftmargin="0" marginheight="0" topmargin=0 frameborder="0" framespacing="0">
<frame name="controlFrame" src="empty.html" scrolling="no" marginwidth="0" leftmargin="0" marginheight="0" topmargin=0 frameborder="0" framespacing="0">
<frame name="pingFrame" src="empty.html" scrolling="no" marginwidth="0" leftmargin="0" marginheight="0" topmargin=0 frameborder="0" framespacing="0">
<frame name="requestFrame" src="empty.html" scrolling="no" marginwidth="0" leftmargin="0" marginheight="0" topmargin=0 frameborder="0" framespacing="0">
<frame name="connectionTextFrame" src="connected.html" scrolling="no" marginwidth="0" leftmargin="0" marginheight="0" topmargin=0 frameborder="0" framespacing="0">
</frameset>

<body> <!-- onLoad="onLoadEvent();"> Is never called-->
</body>
</html>

