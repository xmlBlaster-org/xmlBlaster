<?xml version="1.0"?>
<project default="all" basedir=".">

  <taskdef resource="cpptasks.tasks"/> <!-- cc defineset compiler linker -->
  <typedef resource="cpptasks.types"/>

  <!-- taskdef name="cc" classname="net.sf.antcontrib.cpptasks.CCTask" />
  <typedef name="defineset" classname="net.sf.antcontrib.cpptasks.types.DefineSet" />
  <typedef name="libset" classname="net.sf.antcontrib.cpptasks.types.LibrarySet" />
  <typedef name="compiler" classname="net.sf.antcontrib.cpptasks.CompilerDef" />
  <typedef name="linker" classname="net.sf.antcontrib.cpptasks.LinkerDef" / -->

  <property name="build.dir"     value="./tao_build"/>

  <property name="src.cpp.dir" value="${xmlblaster.home}/src/c++" />

  <!-- TAO setup -->
  <property name="ace.home"     value="${ace.root}" />  
  <property name="corba.home"   value="${ace.home}/TAO"/>
  <property name="corba.dir"    value="./generated"/>      
  <property name="corba1.inc"   value="-I${corba.home}/TAO"/>
  <property name="cos.libs"     value="-L${corba.home}/bin -lCosNaming"/>
  <property name="corba.obj"    value="obj/xmlBlasterC.o obj/xmlBlasterS.o"/>
  <property name="idl.cmd"      value="${ace.home}/bin/tao_idl"/>
  <property name="idl.dir"      value="src/java/org/xmlBlaster/protocol/corba" />
  <property name="lib.dir"      value="${build.dir}"/>
  <property name="debug"        value="true"/>

  <property name="THREAD_SRC" value="${src.cpp.dir}/libs/thread/src"/> <!-- use the internal boost library -->
  <property name="THREAD_INC" value="${src.cpp.dir}"/> <!-- use the internal boost library -->

  <!-- XML lib -->
  <property name="xerces.home" value="${xmlcpp.home}" />

  <property name="use-msvc" value="1" />
  <property name="compiler" value="msvc"/> <!-- "gcc" "VC6" "bcc" -->  

  <compiler id="base-msvc" name="msvc" if="use-msvc">
      <defineset><define name="_WINDOWS" value="1" /></defineset>
      <defineset define="DLL_EXPORT"/>
      <!-- <compilerarg value="/GX" /> -->
      <compilerarg value="/Gm" if="is-debug"/>      
      <compilerarg value="/Zi" if="is-debug"/>      
      <!-- <compilerarg value="/MDd" />  -->        <!-- multi threading with debug -->      
      <compilerarg value="/W3"/>                    <!-- display many warnings -->
      <!-- <compilerarg value="/Od" unless="is-debug"/> --> <!-- maximize speed --> 
      <!-- compilerarg value="/Ob2" unless="is-debug"/ --> <!-- auto-inlining -->      

      <!-- 
      This flag makes good sense though currently ace complains for some reason
      I think it is to do with the way I have built ace
      <defineset>      
         <define name="_CRTDBG_MAP_ALLOC" if="is-debug"/>         
      </defineset>
      -->
      
  </compiler>   

  <compiler id="msvc" name="msvc" extends="base-msvc">
      <!--  disable Microsoft Extensions   -->
      <!-- <compilerarg value="/Za"/> -->
  </compiler>       

  <target name="all" depends="cpp-lib">
    <echo message="Hopefully you now have a xmlBlasterClient lib for TAO ${os.name}"/>        
  </target>

  <target name="prepare-idl" depends="prepare">      
      <echo message="Compiling idl..."/>
      <exec dir="${src.cpp.dir}/generated" executable="${idl.cmd}" failonerror="true">         
         <arg line="-Ge 0 -Wb,pre_include=util/xmlbcfg.h -Wb,export_macro=Dll_Export"/>         
         <arg line="${xmlblaster.home}/${idl.dir}/xmlBlaster.idl"/>
      </exec>            
  </target>

  <target name="cpp-lib" depends="prepare-idl">            
    
    <condition property="is-debug">
      <isTrue value="${debug}"/>
    </condition>

    <mkdir dir="${build.dir}"/>
    <mkdir dir="${build.dir}/obj"/>     
    <cc debug="${debug}" link="shared"      
      outfile="${lib.dir}/xmlBlasterClient" objdir="${build.dir}/obj"
      multithreaded="true" exceptions="true" >      
      <!-- <compiler refid="gcc"/> -->
      <compiler refid="msvc"/>
      <!-- <compiler refid="bcc"/> -->
      <fileset dir="${src.cpp.dir}/generated" includes="*C.cpp"/>
      <fileset dir="${src.cpp.dir}/generated" includes="*S.cpp"/>
      <fileset dir="${src.cpp.dir}/util" includes="*.cpp" />
      <fileset dir="${src.cpp.dir}/util/thread" includes="*.cpp" />
      <fileset dir="${src.cpp.dir}/util/key" includes="*.cpp" />
      <fileset dir="${src.cpp.dir}/util/qos" includes="*.cpp" />
      <fileset dir="${src.cpp.dir}/util/qos/storage" includes="*.cpp" />
      <fileset dir="${src.cpp.dir}/util/qos/address" includes="*.cpp" />
      <fileset dir="${src.cpp.dir}/util/queue" includes="*.cpp" />
      <fileset dir="${src.cpp.dir}/util/dispatch" includes="*.cpp" />
      <fileset dir="${src.cpp.dir}/util/cluster" includes="*.cpp" />
      <fileset dir="${src.cpp.dir}/client" includes="*.cpp" />
      <fileset dir="${src.cpp.dir}/client/protocol" includes="*.cpp" />
      <fileset dir="${src.cpp.dir}/client/qos" includes="*.cpp" />
      <fileset dir="${src.cpp.dir}/client/key" includes="*.cpp" />
      <fileset dir="${src.cpp.dir}/client/protocol/corba" includes="*.cpp" />
      <fileset dir="${src.cpp.dir}/authentication" includes="*.cpp" />
      <fileset dir="${THREAD_SRC}" includes="*.cpp"/>
                 
      <sysincludepath location="${corba.home}/orbsvcs" />          
      <sysincludepath location="${xerces.home}/src"/>            <!-- xerces win32 -->
      <sysincludepath location="${xerces.home}/include" />       <!-- xerces 1.6.0 -->
      <sysincludepath location="${xerces.home}/src/xercesc" />   <!-- Since xerces 1.7.0 that I have -->                  
      <sysincludepath location="${THREAD_INC}" />

      <includepath location="${ms.path}/include" />   
      <includepath location="${ms.path}/mfc/include" />   
      <includepath location="${ms.path}/atl/include" />   
      <includepath location="${ace.home}" />
      <includepath location="${corba.home}" />
      <includepath location="${src.cpp.dir}" /> 
      <includepath location="${src.cpp.dir}/util" />    <!-- for xmlbcfg.h -->
      <includepath location="${src.cpp.dir}/generated" />
      
      <linker name="msvc" if="is-debug" >        
      <fileset dir="${ace.home}/ace" includes="aced.lib" if="is-debug" />      
      <fileset dir="${corba.home}/tao" includes="TAOd.lib" if="is-debug"/>       
      <fileset dir="${corba.home}/tao/PortableServer" includes="TAO_PortableServerd.lib" if="is-debug"/>
      <fileset dir="${corba.home}/orbsvcs/orbsvcs" includes="TAO_CosNamingd.lib" if="is-debug"/>
      <fileset dir="${xerces.home}/Build/Win32/Vc6/Debug" includes="xerces-c_1D.lib" if="is-debug"/>
      </linker>
      
      <linker name="msvc" >        
      <fileset dir="${ace.home}/ace" includes="ace.lib" unless="is-debug" />
      <fileset dir="${corba.home}/tao" includes="TAO.lib" unless="is-debug" />       
      <fileset dir="${corba.home}/tao/PortableServer" includes="TAO_PortableServer.lib" unless="is-debug" />
      <fileset dir="${corba.home}/orbsvcs/orbsvcs" includes="TAO_CosNaming.lib" unless="is-debug" />
      <fileset dir="${xerces.home}/Build/Win32/Vc6/Release" includes="xerces-c_1.lib" unless="is-debug" />
      </linker>

      <defineset>
        <define name="TAO" value="1" />
        <define name="WIN32" value="1" />        
        <define name="_WINDOWS" value="1" />
        <define name="_MBCS" value="1" />
        <define name="_USRDLL" value="1" />
        <define name="DLL_BUILD" value="1" />
        <!-- undefine name="UNWANTEDDEF" / -->
      </defineset>
    </cc>
  </target>
  

  <target name="prepare" >      
      <echo message="configured for TAO ${os.name}" />
      <!-- 
      <osfamily property="os.family" />      
      <echo message=" OS_FAMILY     = ${os.family}"/>  
      <switch value="osfamily" caseinsensitive="false">
         <case value="unix">
            <property name="BUILD_UNIX" value="true" />
            <property name="unix" value="true" />
         </case>
         <default>
            <property name="BUILD_WINDOWS" value="true" />
            <property name="windows" value="true" />
            <echo message="this is expected ${os.name}"/>
         </default>
      </switch> -->
      <condition property="linux">
         <equals arg1="${os.name}" arg2="Linux"/>
      </condition>
   </target>

   <target name="clean">
       <delete dir="${build.dir}/obj"/>
       <delete dir="${build.dir}"/>
       <delete>
         <fileset dir="${src.cpp.dir}/generated" includes="*.cpp"/>
         <fileset dir="${src.cpp.dir}/generated" includes="*.i"/>
         <fileset dir="${src.cpp.dir}/generated" includes="*.h"/>
       </delete>
   </target>
 
</project>


<!-- End of file -->
