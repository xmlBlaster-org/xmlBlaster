<?xml version='1.0' encoding='ISO-8859-1' ?>
<!DOCTYPE requirement SYSTEM "requirement.dtd">

<requirement id='protocol.socket' type='NEW' prio='HIGH' status="INWORK">
   <topic>XmlBlaster supports a bidirectional native communication protocol using exactly one socket connection</topic>
   <description>
      <p>
      RPC (remote procedure call) based frameworks like CORBA, RMI and XmlRpc require the client
      to set up a callback server for asynchronous callbacks. This causes problems if the client
      is behind a firewall or if the client may not establish a listen socket.
      Reusing a socket for callbacks solves this problem.
      </p>
      <h3>
      Protocol specification
      </h3>
   <p>
   Design decisions:
   </p>
   <ul>
     <li>Uses no bit settings to allow simple access with any programming language</li>
     <li>To avoid bigendian/littleendian problems no netlong etc. are used</li>
     <li>Numbers are delivered as strings, right justified</li>
     <li>All header fields have even boundaries</li>
     <li>Compact format for good performance</li>
   </ul>
   <br />
   <p>
   This specifies the raw data format, '*' is used to symbolize null terminated strings:
   </p>
   <pre>
    msgLen[10] flag[6] requestId methodName sessionId  lenUnzipped  userData  checkSum[10]
    +---------+-------+------ -*----------*-----------*-----------*-----------+----------+
   </pre>
   <p>
   Description:
   </p>
   <table width="100%">
      <tr>
         <td>Field</td>
         <td>Description</td>
         <td>Size [bytes]</td>
      </tr>
      <tr>
         <td>msgLen</td>
         <td>The number of bytes of the message, including itself, the header, the data (and the checksum if appended)</td>
         <td>10</td>
      </tr>
      <tr>
         <td>flag</td>
         <td>The flag defaults to zero (all bits are '\0', only version is set to one '1'=49 and 'I'=73 for invoke), possible settings of each byte are:
            <ol>
               <li>65 (typically 'A') Adler32 checksum is appended (see java.util.zip)</li>
               <li>90 (typically 'Z') The userData is compressed with gzip (see java.uti.zip)</li>
               <li>Type of message<ul><li>73 (typically 'I') for invoke request</li><li>82 (typically 'R') for return value</li><li>69 (typically 'E') for exception</li></ul></li>
               <li>null ('\0'), Reserved</li>
               <li>null ('\0'), Reserved</li>
               <li>49 (typically '1') Version byte for this protocol</li>
            </ol>
         </td>
         <td>6</td>
      </tr>
      <tr>
         <td>requestId</td>
         <td>A identifier of this request (unique in client scope), the return message will contain this ID</td>
         <td>null terminated</td>
      </tr>
      <tr>
         <td>methodName</td>
         <td>The method to invoke, like "publish", "subscribe", "update"</td>
         <td>null terminated</td>
      </tr>
      <tr>
         <td>lenUnzipped</td>
         <td>The length of the uncompressed user data, allows for example in C to simple allocate enough memory. This field is only appended if the flag is set to 'Z' (compressed).</td>
         <td>null terminated</td>
      </tr>
      <tr>
         <td>userData</td>
         <td>The arguments of the invoked message (see below)</td>
         <td>any</td>
      </tr>
      <tr>
         <td>checkSum</td>
         <td>An optional checksum if the flag field is set</td>
         <td>10</td>
      </tr>
   </table>
   <br />
   <p>
   The userData has the following typical layout.
   </p>
   <pre>
     qos      key    len   content
   +-----*---------*-----*----------+
   </pre>
   <p>
   len is the length of the content.<br />
   This may be repeated multiple times if an array of MessageUnits is sent.
   </p>
   <p>
   The following table lists all allowed methods, with their arguments, return values and exceptions.<br />
   Note that all data types are of type string and are terminated with a '\0'.<br />
   Only the content is of type 'binary' which length can be calculated by the
   len field. Binary data is not zero terminated.
   </p>
   <table width="100%">
      <tr>
         <td>Method</td>
         <td>Arguments</td>
         <td>Return value</td>
         <td>Exception</td>
         <td>Comment</td>
      </tr>
      <tr>
         <td>connect</td>
         <td>QoS{string}</td>
         <td>QoS{string}</td>
         <td>yes</td>
         <td>The sessionId field is an empty string (just the '\0')</td>
      </tr>
      <tr>
         <td>disconnect</td>
         <td>QoS{string}</td>
         <td>QoS string</td>
         <td>yes</td>
         <td></td>
      </tr>
      <tr>
         <td>ping</td>
         <td>QoS{string}</td>
         <td>QoS{string}</td>
         <td>no</td>
         <td>The QoS can be an empty string ""</td>
      </tr>
      <tr>
         <td>{exception}</td>
         <td>id{string}, reason{string}</td>
         <td>-</td>
         <td>no</td>
         <td>Exception return messages are named similar to the invoked method but are marked with an 'E' flag</td>
      </tr>
      <tr>
         <td>update</td>
         <td>[QoS{string}, key{string}, content{binary}]*</td>
         <td>QoS string</td>
         <td>yes</td>
         <td>This is a callback message to the client, the QoS, key, content may be specified multiple times</td>
      </tr>
      <tr>
         <td>publish</td>
         <td>[QoS{string}, key{string}, content{binary}]*</td>
         <td>QoS string</td>
         <td>yes</td>
         <td>The QoS, key, content may be specified multiple times</td>
      </tr>
      <tr>
         <td>get</td>
         <td>QoS{string}, key{string}</td>
         <td>[QoS{string}, key{string}, content{binary}]*</td>
         <td>yes</td>
         <td>The returned QoS, key, content may be multiple items</td>
      </tr>
      <tr>
         <td>subscribe</td>
         <td>QoS{string}, key{string}</td>
         <td>QoS string</td>
         <td>yes</td>
         <td></td>
      </tr>
      <tr>
         <td>unSubscribe</td>
         <td>QoS{string}, key{string}</td>
         <td>QoS string</td>
         <td>yes</td>
         <td>cancel a subscription</td>
      </tr>
      <tr>
         <td>erase</td>
         <td>QoS{string}, key{string}</td>
         <td>QoS string</td>
         <td>yes</td>
         <td></td>
      </tr>
   </table>
   </description>
   <example lang="Java">
      <![CDATA[
Example for a publish() request:

   "        82  I  112*publish*eZ64bfgHj**41<qos></qos>*<key oid='hello'/>*Hello world"
   
The response:

   "        36  R  112*publish***6hello*"

The response if an exception occurred:

   "        75  E  112*publish***44QueueOverflow*The destination queue is full*"

The '*' is used as a symbol for a '\0' character (all zero bits) which terminates strings.
The content of a message, here 'Hello world' is binary data and has no '\0', it is determined by len.
      ]]>
   </example>
   <see type="REQ">protocol</see>
   <author>ruff@swand.lake.de</author>
   <date>2002 02 12</date>
   <revision>$Revision: 1.3 $</revision>
   <testcase status="OPEN">
      <name>-</name>
      <comment>-</comment>
      <test tool="SUITE">testsuite.</test>
   </testcase>
</requirement>

